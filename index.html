<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>José Barbearia</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  font-family: Arial;
  background: #0d1b2a;
  color: white;
  text-align: center;
  padding: 20px;
}

.container {
  background: #1b263b;
  padding: 20px;
  border-radius: 10px;
  max-width: 400px;
  margin: auto;
}

input, select, button {
  width: 100%;
  padding: 12px;
  margin-top: 10px;
  border-radius: 6px;
  border: none;
  font-size: 16px;
}

button {
  background: #e63946;
  color: white;
  font-weight: bold;
}
</style>
</head>
<body>

<div class="container">
  <h2>José Barbearia</h2>

  <input type="text" id="nome" placeholder="Seu nome">
  <input type="date" id="data">

  <select id="servico">
    <option value="">Selecione o serviço</option>
    <option value="Corte|50">Corte – 50 min – R$30</option>
    <option value="Barba|30">Barba – 30 min – R$20</option>
    <option value="Corte+Barba|60">Corte + Barba – 60 min – R$45</option>
    <option value="Infantil|40">Infantil – 40 min – R$25</option>
  </select>

  <select id="hora">
    <option value="">Selecione o horário</option>
  </select>

  <button onclick="agendar()">Agendar</button>

  <p id="msg"></p>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getFirestore,
  collection,
  addDoc,
  getDocs,
  query,
  where
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "SUA_API_KEY",
  authDomain: "jose-barbearia.firebaseapp.com",
  projectId: "jose-barbearia",
  storageBucket: "jose-barbearia.appspot.com",
  messagingSenderId: "SEU_ID",
  appId: "SEU_APP_ID"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// horários base 09:00 até 18:00 de 10 em 10 minutos
const horariosBase = [];
for (let h = 9; h <= 18; h++) {
  for (let m = 0; m < 60; m += 10) {
    if (h === 18 && m > 0) continue;
    horariosBase.push(
      String(h).padStart(2, "0") + ":" +
      String(m).padStart(2, "0")
    );
  }
}

const dataInput = document.getElementById("data");
const servicoInput = document.getElementById("servico");
const selectHora = document.getElementById("hora");

dataInput.addEventListener("change", carregarHorarios);
servicoInput.addEventListener("change", carregarHorarios);

function horaParaMin(h) {
  const [hh, mm] = h.split(":").map(Number);
  return hh * 60 + mm;
}

function minParaHora(min) {
  const h = Math.floor(min / 60);
  const m = min % 60;
  return String(h).padStart(2,"0") + ":" + String(m).padStart(2,"0");
}

async function carregarHorarios() {

  const data = dataInput.value;
  const servicoVal = servicoInput.value;

  if (!data || !servicoVal) return;

  const duracaoSelecionada = parseInt(servicoVal.split("|")[1]);

  selectHora.innerHTML = "<option>Carregando...</option>";

  const q = query(
    collection(db, "agendamentos"),
    where("data", "==", data)
  );

  const snapshot = await getDocs(q);

  let ocupados = [];

  snapshot.forEach(doc => {
    const ag = doc.data();

    const inicio = horaParaMin(ag.hora);

    // se agendamentos antigos não tiverem duração
    const duracaoAg = ag.duracao ? ag.duracao : 60;

    const fim = inicio + duracaoAg;

    for (let t = inicio; t < fim; t += 10) {
      ocupados.push(minParaHora(t));
    }
  });

  selectHora.innerHTML = "<option value=''>Selecione o horário</option>";

  horariosBase.forEach(h => {

    const inicio = horaParaMin(h);
    const fim = inicio + duracaoSelecionada;

    let conflito = false;

    for (let t = inicio; t < fim; t += 10) {
      if (ocupados.includes(minParaHora(t))) {
        conflito = true;
        break;
      }
    }

    if (!conflito) {
      const opt = document.createElement("option");
      opt.value = h;
      opt.textContent = h;
      selectHora.appendChild(opt);
    }
  });
}

window.agendar = async function() {

  const nome = document.getElementById("nome").value;
  const data = dataInput.value;
  const hora = selectHora.value;
  const servicoVal = servicoInput.value;
  const msg = document.getElementById("msg");

  if (!nome || !data || !hora || !servicoVal) {
    msg.innerText = "Preencha tudo!";
    return;
  }

  const [servico, duracaoStr] = servicoVal.split("|");
  const duracao = parseInt(duracaoStr);

  await addDoc(collection(db, "agendamentos"), {
    nome,
    data,
    hora,
    servico,
    duracao,
    criadoEm: new Date()
  });

  msg.innerText = "Agendamento realizado com sucesso!";
  document.getElementById("nome").value = "";
  carregarHorarios();
};

</script>

</body>
</html>
