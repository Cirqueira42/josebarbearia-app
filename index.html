<!DOCTYPE html>

<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>José Barbearia</title>

<style>
body{
background:#0b0b0b;
color:#fff;
font-family:Arial;
margin:0;
}
.container{
max-width:420px;
margin:auto;
padding:20px;
}
h1{
color:#00c853;
text-align:center;
}
input,select{
width:100%;
padding:14px;
margin-top:10px;
border-radius:10px;
border:none;
font-size:16px;
}
.horarios{
display:grid;
grid-template-columns:repeat(3,1fr);
gap:10px;
margin-top:20px;
}
.horarios button{
padding:14px;
border:none;
border-radius:10px;
background:#1f1f1f;
color:#fff;
font-size:16px;
}
.confirmar{
width:100%;
margin-top:20px;
padding:16px;
background:#00c853;
border:none;
border-radius:12px;
font-size:18px;
color:#fff;
}
#status{
margin-top:10px;
text-align:center;
}
.admin{
background:#111;
padding:15px;
margin-top:40px;
border-radius:10px;
}
</style>

</head>
<body>

<div class="container">
<h1>José Barbearia</h1>

<input id="nome" placeholder="Seu nome">
<input id="telefone" placeholder="Telefone">

<select id="servico">
<option value="45">Corte - 45min</option>
<option value="30">Barba - 30min</option>
<option value="60">Corte + Barba - 60min</option>
<option value="40">Infantil - 40min</option>
</select>

<input type="date" id="data">

<h3>Horários</h3>
<div class="horarios" id="horarios"></div>

<button class="confirmar" onclick="agendar()">Confirmar Agendamento</button>

<div id="status"></div>

<div id="adminArea" class="admin" style="display:none">
<h2>Painel ADM</h2>
<input type="date" id="adminData">
<button onclick="verAgendamentos()">Ver Agendamentos</button>
<button onclick="bloquearDia()">Bloquear Dia Inteiro</button>
<div id="listaAdmin"></div>
</div>

</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
// COLE SEU FIREBASE AQUI
const firebaseConfig = {
apiKey: "SUA_API_KEY",
authDomain: "SEU_PROJETO.firebaseapp.com",
databaseURL: "https://SEU_PROJETO-default-rtdb.firebaseio.com",
projectId: "SEU_PROJETO",
storageBucket: "SEU_PROJETO.appspot.com",
messagingSenderId: "XXXX",
appId: "XXXX"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let horarioSelecionado = null;

// GERAR HORÁRIOS (corrigido)
function gerarHorarios(){
const div = document.getElementById("horarios");
div.innerHTML = "";

const dataSelecionada = document.getElementById("data").value;
if(!dataSelecionada) return;

const hoje = new Date();
const hojeStr = hoje.toISOString().split("T")[0];

if(dataSelecionada < hojeStr){
div.innerHTML = "<p>Data indisponível</p>";
return;
}

firebase.database().ref("agendamentos/"+dataSelecionada).once("value", snap=>{

const ocupados = snap.val() || {};

for(let h=9; h<19; h++){
for(let m=0; m<60; m+=10){

let hora = (h<10?"0"+h:h)+":"+(m==0?"00":m);

if(ocupados[hora]) continue;

if(dataSelecionada === hojeStr){
let agoraHora = hoje.getHours();
let agoraMin = hoje.getMinutes();

let horaNum = parseInt(hora.split(":")[0]);
let minNum = parseInt(hora.split(":")[1]);

if(horaNum < agoraHora) continue;
if(horaNum === agoraHora && minNum <= agoraMin) continue;
}

let btn = document.createElement("button");
btn.innerText = hora;

btn.onclick = () => {
document.querySelectorAll(".horarios button").forEach(b=>{
b.style.background="#1f1f1f";
});
btn.style.background="#00c853";
horarioSelecionado = hora;
};

div.appendChild(btn);
}
}

if(div.innerHTML === ""){
div.innerHTML = "<p>Sem horários disponíveis</p>";
}

});
}

document.getElementById("data").addEventListener("change", gerarHorarios);

// AGENDAR
function agendar(){
const nome = document.getElementById("nome").value;
const telefone = document.getElementById("telefone").value;
const data = document.getElementById("data").value;
const duracao = parseInt(document.getElementById("servico").value);
const status = document.getElementById("status");

if(!nome || !telefone || !data || !horarioSelecionado){
status.innerText="Preencha tudo";
return;
}

const codigo = Math.random().toString(36).substring(2,8).toUpperCase();

let inicio = new Date(data+"T"+horarioSelecionado);

for(let i=0;i<duracao;i+=10){
let slot = new Date(inicio.getTime() + i*60000);
let hora = slot.toTimeString().slice(0,5);

firebase.database().ref("agendamentos/"+data+"/"+hora).set({
nome,
telefone,
codigo
});
}

const msg = `Olá ${nome}, seu horário foi confirmado!

Data: ${data}
Hora: ${horarioSelecionado}

Cancelar:
${window.location.origin}${window.location.pathname}?cancelar=${data}_${horarioSelecionado}`;

window.open("https://wa.me/55"+telefone+"?text="+encodeURIComponent(msg));

status.innerText="Agendamento confirmado!";
horarioSelecionado=null;
gerarHorarios();
}

// CANCELAMENTO + AVISO
window.onload = function(){

const url = new URL(window.location.href);
const cancelar = url.searchParams.get("cancelar");
const admin = url.searchParams.get("admin");

// ativar admin
if(admin === "1020"){
document.getElementById("adminArea").style.display="block";
}

// cancelamento
if(cancelar){
const partes = cancelar.split("_");
const data = partes[0];
const hora = partes[1];

if(confirm("Deseja realmente cancelar o agendamento das " + hora + " ?")){

for(let i=0;i<60;i+=10){
let slot = new Date(data + "T" + hora);
slot = new Date(slot.getTime() + i*60000);
let h = slot.toTimeString().slice(0,5);
firebase.database().ref("agendamentos/"+data+"/"+h).remove();
}

alert("Agendamento cancelado!");

// aviso para você
const mensagem = `Cancelamento confirmado!
Data: ${data}
Hora: ${hora}`;

window.open("https://wa.me/5516997369740?text="+encodeURIComponent(mensagem));

window.location.href = window.location.pathname;
}
}
}

// ADMIN
function verAgendamentos(){
const data = document.getElementById("adminData").value;
const lista = document.getElementById("listaAdmin");
lista.innerHTML="";

firebase.database().ref("agendamentos/"+data).once("value", snap=>{
const dados = snap.val();
if(!dados){
lista.innerHTML="Nenhum agendamento";
return;
}

Object.keys(dados).forEach(hora=>{
const ag = dados[hora];
if(ag.nome){
lista.innerHTML += `
<div style="background:#1f1f1f;padding:10px;margin:5px;border-radius:8px">
<b>${hora}</b><br>
${ag.nome}<br>
${ag.telefone}
</div>`;
}
});
});
}

function bloquearDia(){
const data = document.getElementById("adminData").value;

for(let h=9; h<19; h++){
for(let m=0; m<60; m+=10){
let hora = (h<10?"0"+h:h)+":"+(m==0?"00":m);
firebase.database().ref("agendamentos/"+data+"/"+hora).set({bloqueado:true});
}
}
alert("Dia bloqueado!");
}
</script>

</body>
</html>
