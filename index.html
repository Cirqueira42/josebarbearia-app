<!DOCTYPE html>

<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>José Barbearia</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  font-family: Arial;
  background: #0d1b2a;
  color: white;
  text-align: center;
  padding: 20px;
}

.container {
  background: #1b263b;
  padding: 20px;
  border-radius: 10px;
  max-width: 400px;
  margin: auto;
}

input, select, button {
  width: 100%;
  padding: 12px;
  margin-top: 10px;
  border-radius: 6px;
  border: none;
  font-size: 16px;
}

button {
  background: #e63946;
  color: white;
  font-weight: bold;
}

h1 {
  margin-bottom: 5px;
}

small {
  color: #ccc;
}
</style>

</head>
<body>

<div class="container">
  <h1>José Barbearia</h1>
  <small>Agende seu horário</small>

  <input type="text" id="nome" placeholder="Seu nome">

  <input type="date" id="data">

  <select id="servico">
    <option value="">Selecione o serviço</option>
    <option value="Corte|50">Corte - 50 min</option>
    <option value="Barba|30">Barba - 30 min</option>
    <option value="Corte+Barba|60">Corte + Barba - 60 min</option>
    <option value="Infantil|40">Corte Infantil - 40 min</option>
  </select>

  <select id="hora">
    <option value="">Selecione o horário</option>
  </select>

<button onclick="agendar()">Agendar</button>

  <p id="msg"></p>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getFirestore,
  collection,
  addDoc,
  getDocs,
  query,
  where
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/* COLE SEU firebaseConfig AQUI */
const firebaseConfig = {
  apiKey: "SUA_API_KEY",
  authDomain: "jose-barbearia.firebaseapp.com",
  projectId: "jose-barbearia",
  storageBucket: "jose-barbearia.appspot.com",
  messagingSenderId: "SEU_ID",
  appId: "SEU_APP_ID"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// Horários de 10 em 10 minutos
const horariosFixos = [];
for (let h = 9; h <= 18; h++) {
  for (let m = 0; m < 60; m += 10) {
    if (h === 18 && m > 0) continue;
    horariosFixos.push(
      String(h).padStart(2, "0") + ":" +
      String(m).padStart(2, "0")
    );
  }
}

const selectHora = document.getElementById("hora");
const dataInput = document.getElementById("data");

dataInput.addEventListener("change", carregarHorarios);

async function carregarHorarios() {
  const data = dataInput.value;
  selectHora.innerHTML = "<option>Carregando...</option>";

  const q = query(
    collection(db, "agendamentos"),
    where("data", "==", data)
  );

  const snapshot = await getDocs(q);

  let ocupados = [];

  snapshot.forEach(doc => {
    const ag = doc.data();
    const horaInicio = ag.hora;
    const duracao = ag.duracao || 0;

    let [h, m] = horaInicio.split(":").map(Number);
    let total = h * 60 + m;

    for (let i = 0; i < duracao; i += 10) {
      let min = total + i;
      let hh = Math.floor(min / 60);
      let mm = min % 60;

      ocupados.push(
        String(hh).padStart(2, "0") + ":" +
        String(mm).padStart(2, "0")
      );
    }
  });

  selectHora.innerHTML = "<option value=''>Selecione o horário</option>";

  horariosFixos.forEach(h => {
    if (!ocupados.includes(h)) {
      let opt = document.createElement("option");
      opt.value = h;
      opt.textContent = h;
      selectHora.appendChild(opt);
    }
  });
}

window.agendar = async function() {
  const nome = document.getElementById("nome").value;
  const data = dataInput.value;
  const hora = selectHora.value;
  const servicoSelect = document.getElementById("servico").value;
  const msg = document.getElementById("msg");

  if (!nome || !data || !hora || !servicoSelect) {
    msg.innerText = "Preencha tudo!";
    return;
  }

  const [servico, duracaoStr] = servicoSelect.split("|");
  const duracao = parseInt(duracaoStr);

  // Segurança contra duplicação
  const q = query(
    collection(db, "agendamentos"),
    where("data", "==", data),
    where("hora", "==", hora)
  );

  const snap = await getDocs(q);
  if (!snap.empty) {
    msg.innerText = "Horário já ocupado!";
    carregarHorarios();
    return;
  }

  await addDoc(collection(db, "agendamentos"), {
    nome,
    data,
    hora,
    servico,
    duracao,
    criadoEm: new Date()
  });

  msg.innerText = "Agendado com sucesso!";
  document.getElementById("nome").value = "";
  carregarHorarios();
};

</script>

</body>
</html>
