<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Jos√© Barbearia</title>

<style>
body{
background:#0b0b0b;
color:#fff;
font-family:Arial;
margin:0;
}

.container{
max-width:420px;
margin:auto;
padding:20px;
}

h1{
color:#00c853;
text-align:center;
}

input,select{
width:100%;
padding:14px;
margin-top:10px;
border-radius:10px;
border:none;
font-size:16px;
}

.horarios{
display:grid;
grid-template-columns:repeat(3,1fr);
gap:10px;
margin-top:20px;
}

.btn-horario{
padding:14px;
border:none;
border-radius:10px;
background:#1f1f1f;
color:#fff;
font-size:16px;
}

.confirmar{
width:100%;
margin-top:20px;
padding:16px;
background:#00c853;
border:none;
border-radius:12px;
font-size:18px;
color:#fff;
font-weight:bold;
}

#status{
margin-top:10px;
text-align:center;
font-weight:bold;
}
</style>
</head>

<body>

<div class="container">
<h1>Jos√© Barbearia</h1>

<input id="nome" placeholder="Seu nome">
<input id="telefone" placeholder="Telefone (somente n√∫meros)">

<select id="servico">
<option value="45">Corte - 45min</option>
<option value="30">Barba - 30min</option>
<option value="60">Corte + Barba - 60min</option>
<option value="40">Infantil - 40min</option>
</select>

<input type="date" id="data">

<h3>Hor√°rios</h3>
<div class="horarios" id="horarios"></div>

<button class="confirmar" onclick="agendar()">Confirmar Agendamento</button>

<div id="status"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
// üî• COLE SEU FIREBASE AQUI
const firebaseConfig = {
apiKey: "SUA_API_KEY",
authDomain: "SEU_PROJETO.firebaseapp.com",
databaseURL: "https://SEU_PROJETO-default-rtdb.firebaseio.com",
projectId: "SEU_PROJETO",
storageBucket: "SEU_PROJETO.appspot.com",
messagingSenderId: "XXXX",
appId: "XXXX"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let horarioSelecionado = null;
let duracaoSelecionada = 0;

const inputData = document.getElementById("data");
const hojeISO = new Date().toISOString().split("T")[0];
inputData.min = hojeISO;

inputData.addEventListener("change", function(){
gerarHorarios(this.value);
});

// üî• GERAR HOR√ÅRIOS CORRIGIDO DEFINITIVO
function gerarHorarios(dataSelecionada){

const container = document.getElementById("horarios");
container.innerHTML = "";

if(!dataSelecionada) return;

const agora = new Date();
const hoje = new Date();
hoje.setHours(0,0,0,0);

const dataEscolhida = new Date(dataSelecionada + "T00:00:00");
dataEscolhida.setHours(0,0,0,0);

if(dataEscolhida < hoje){
container.innerHTML = "<p style='color:red'>Data indispon√≠vel</p>";
return;
}

db.ref("agendamentos/"+dataSelecionada).once("value", snapshot=>{

const ocupados = snapshot.val() || {};

const inicioExpediente = 9;
const fimExpediente = 19;

for(let hora = inicioExpediente; hora < fimExpediente; hora++){

for(let minuto = 0; minuto < 60; minuto += 10){

let horaFormatada = hora.toString().padStart(2,'0');
let minutoFormatado = minuto.toString().padStart(2,'0');
let horarioTexto = horaFormatada + ":" + minutoFormatado;

let dataHoraSlot = new Date(dataSelecionada + "T" + horarioTexto);

// bloquear passado do dia atual
if(dataEscolhida.getTime() === hoje.getTime()){
if(dataHoraSlot <= agora) continue;
}

// se j√° ocupado n√£o mostra
if(ocupados[horarioTexto]) continue;

let btn = document.createElement("button");
btn.innerText = horarioTexto;
btn.className = "btn-horario";

btn.onclick = function(){

document.querySelectorAll(".btn-horario").forEach(b=>{
b.style.background="#1f1f1f";
});

btn.style.background="#00c853";
horarioSelecionado = horarioTexto;
};

container.appendChild(btn);
}
}
});
}

// üî• AGENDAR
function agendar(){

const nome = document.getElementById("nome").value;
const telefone = document.getElementById("telefone").value;
const data = document.getElementById("data").value;
const duracao = parseInt(document.getElementById("servico").value);
const status = document.getElementById("status");

if(!nome || !telefone || !data || !horarioSelecionado){
status.innerText="Preencha todos os campos";
return;
}

let inicio = new Date(data+"T"+horarioSelecionado);

// bloquear todos os slots da dura√ß√£o
for(let i=0;i<duracao;i+=10){
let slot = new Date(inicio.getTime() + i*60000);
let hora = slot.toTimeString().slice(0,5);

db.ref("agendamentos/"+data+"/"+hora).set({
nome,
telefone,
inicio: horarioSelecionado,
duracao
});
}

// link cancelamento
const linkCancelamento = 
window.location.origin+
window.location.pathname+
"?cancelar="+data+"_"+horarioSelecionado+"_"+duracao;

const msg = `Ol√° ${nome}, seu hor√°rio foi confirmado!

Data: ${data}
Hora: ${horarioSelecionado}

Para cancelar:
${linkCancelamento}`;

window.open("https://wa.me/55"+telefone+"?text="+encodeURIComponent(msg));

status.innerText="Agendamento confirmado!";
horarioSelecionado=null;
gerarHorarios(data);
}

// üî• CANCELAMENTO INTELIGENTE
window.onload = function(){

const url = new URL(window.location.href);
const cancelar = url.searchParams.get("cancelar");

if(cancelar){

const partes = cancelar.split("_");
const data = partes[0];
const hora = partes[1];
const duracao = parseInt(partes[2]);

if(confirm("Deseja cancelar o hor√°rio das "+hora+"?")){

let inicio = new Date(data+"T"+hora);

for(let i=0;i<duracao;i+=10){
let slot = new Date(inicio.getTime() + i*60000);
let h = slot.toTimeString().slice(0,5);
db.ref("agendamentos/"+data+"/"+h).remove();
}

alert("Cancelamento confirmado!");

// aviso pra voc√™
const mensagem = `Cancelamento confirmado!

Data: ${data}
Hora: ${hora}`;

window.open(
"https://wa.me/5516997369740?text="+encodeURIComponent(mensagem),
"_blank"
);

window.location.href = window.location.pathname;
}
}
};

</script>

</body>
</html>
