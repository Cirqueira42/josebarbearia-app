<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Jos√© Barbearia</title>

<style>
body {
  font-family: Arial, sans-serif;
  background: #111;
  color: #fff;
  text-align: center;
  margin: 0;
  padding: 20px;
}

.container {
  max-width: 420px;
  margin: auto;
  background: #1c1c1c;
  padding: 20px;
  border-radius: 10px;
}

input, button {
  width: 100%;
  padding: 10px;
  margin-top: 10px;
  border-radius: 5px;
  border: none;
}

button {
  background: #00c853;
  color: #fff;
  font-size: 16px;
  cursor: pointer;
}

button:hover {
  background: #00a844;
}

#horarios button {
  margin: 4px;
  width: 30%;
  background: #333;
}

#horarios button.selected {
  background: #00c853;
}

.admin-box {
  background: #222;
  margin-top: 10px;
  padding: 10px;
  border-radius: 8px;
  text-align: left;
}
</style>
</head>
<body>

<div class="container">
<h2>Agende seu hor√°rio</h2>

<input type="text" id="nome" placeholder="Seu nome">
<input type="date" id="data">

<div id="horarios"></div>

<button onclick="agendar()">Confirmar Agendamento</button>

<p id="status"></p>

<hr>
<h3>√Årea Administrativa</h3>

<input type="date" id="adminData">
<button onclick="carregarAdmin()">Ver Agendamentos</button>
<button onclick="bloquearDia()">Bloquear Dia Inteiro</button>

<div id="listaAdmin"></div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, push, onValue, set } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

/* ===== COLE SEU FIREBASE AQUI ===== */
const firebaseConfig = {
  apiKey: "SUA_API_KEY",
  authDomain: "SEU_PROJETO.firebaseapp.com",
  databaseURL: "https://SEU_PROJETO-default-rtdb.firebaseio.com",
  projectId: "SEU_PROJETO",
  storageBucket: "SEU_PROJETO.appspot.com",
  messagingSenderId: "XXXX",
  appId: "XXXX"
};
/* ================================== */

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ===== CONFIGURA√á√ïES ===== */
const duracaoServicoMin = 40; // dura√ß√£o do corte
const intervaloMin = 10; // intervalo entre hor√°rios
const inicioExpediente = 8 * 60; // 08:00
const fimExpediente = 18 * 60; // 18:00

let horariosFixos = [];
let horarioSelecionado = null;

/* ===== GERAR HOR√ÅRIOS DE 10 EM 10 ===== */
function gerarHorarios() {
  for (let i = inicioExpediente; i < fimExpediente; i += intervaloMin) {
    const h = String(Math.floor(i / 60)).padStart(2, '0');
    const m = String(i % 60).padStart(2, '0');
    horariosFixos.push(`${h}:${m}`);
  }
}
gerarHorarios();

const horariosDiv = document.getElementById("horarios");
const dataInput = document.getElementById("data");

dataInput.addEventListener("change", carregarHorarios);

/* ===== CARREGAR HOR√ÅRIOS DISPON√çVEIS ===== */
function carregarHorarios() {
  const data = dataInput.value;
  if (!data) return;

  const agRef = ref(db, "agendamentos/" + data);

  onValue(agRef, (snapshot) => {
    horariosDiv.innerHTML = "";
    const dados = snapshot.val() || {};
    const ocupados = Object.values(dados).map(d => d.horario);

    horariosFixos.forEach(h => {
      if (!ocupados.includes(h)) {
        const btn = document.createElement("button");
        btn.textContent = h;
        btn.onclick = () => selecionarHorario(btn, h);
        horariosDiv.appendChild(btn);
      }
    });

    if (horariosDiv.innerHTML === "") {
      horariosDiv.innerHTML = "<p>Todos hor√°rios ocupados</p>";
    }
  });
}

function selecionarHorario(btn, horario) {
  document.querySelectorAll("#horarios button")
    .forEach(b => b.classList.remove("selected"));
  btn.classList.add("selected");
  horarioSelecionado = horario;
}

/* ===== AGENDAR COM BLOQUEIO INTELIGENTE ===== */
window.agendar = function() {
  const nome = document.getElementById("nome").value;
  const data = dataInput.value;
  const status = document.getElementById("status");

  if (!nome || !data || !horarioSelecionado) {
    status.textContent = "Preencha tudo";
    return;
  }

  const codigo = Math.random().toString(36).substring(2, 10).toUpperCase();
  const agRef = ref(db, "agendamentos/" + data);

  const blocos = duracaoServicoMin / intervaloMin;

  const [hBase, mBase] = horarioSelecionado.split(":").map(Number);
  const baseMin = hBase * 60 + mBase;

  const promessas = [];

  for (let i = 0; i < blocos; i++) {
    const total = baseMin + (i * intervaloMin);
    const h = String(Math.floor(total / 60)).padStart(2, '0');
    const m = String(total % 60).padStart(2, '0');

    promessas.push(push(agRef, {
      nome,
      horario: `${h}:${m}`,
      codigo,
      servico: "CORTE",
      profissional: "JOSE GILMARIO"
    }));
  }

  Promise.all(promessas).then(() => {

    const dataFormatada = new Date(data).toLocaleDateString("pt-BR", {
      weekday: 'long',
      day: 'numeric',
      month: 'long',
      year: 'numeric'
    });

    const mensagem =
`Ol√°, ${nome} o seu agendamento com a *Jos√© Barbearia* foi confirmado!

*Servi√ßo:* CORTE
*Quando:* ${dataFormatada} √†s ${horarioSelecionado}
*Dura√ß√£o:* 40 minutos
*Profissional:* JOSE GILMARIO
*C√≥digo:* ${codigo}

üìçEndere√ßo: Av. Ot√°vio Rangel, 477 - Vila Cecap, Guariba - SP

üìçLink Google Maps:
https://maps.app.goo.gl/JVahTmuAYLfAiyx57`;

    const telefone = "5516997369740";
    const url = `https://wa.me/${telefone}?text=${encodeURIComponent(mensagem)}`;
    window.open(url, "_blank");

    status.textContent = "Agendamento confirmado!";
    horarioSelecionado = null;
    carregarHorarios();
  });
}

/* ===== ADMIN ===== */
window.carregarAdmin = function() {
  const data = document.getElementById("adminData").value;
  const lista = document.getElementById("listaAdmin");
  if (!data) return;

  const agRef = ref(db, "agendamentos/" + data);

  onValue(agRef, (snapshot) => {
    lista.innerHTML = "<h4>Agendamentos:</h4>";
    const dados = snapshot.val();

    if (!dados) {
      lista.innerHTML += "<p>Nenhum agendamento</p>";
      return;
    }

    Object.values(dados).forEach(ag => {
      lista.innerHTML += `
      <div class="admin-box">
        <b>${ag.horario}</b> - ${ag.nome}<br>
        C√≥digo: ${ag.codigo}
      </div>`;
    });
  });
}

window.bloquearDia = function() {
  const data = document.getElementById("adminData").value;
  if (!data) return alert("Escolha a data");

  const agRef = ref(db, "agendamentos/" + data);

  const bloqueios = {};
  horariosFixos.forEach(h => {
    bloqueios[h] = {
      nome: "BLOQUEADO",
      horario: h
    };
  });

  set(agRef, bloqueios).then(() => alert("Dia bloqueado"));
}
</script>

</body>
</html>
